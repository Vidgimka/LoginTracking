Готовые исправлений:
1) КАждый раз на каждый запрос создавать новое соедниенеие к бд нельзя
Это очень медленно и соединения закончатс,Их надо закрывать.
2) Нужно в создать его только раз в main
и везде испольльзовать для запросов передавая по указателю
3) Добавлена новая колонка в БД с автоматической записью времени записи данных

Исправленияв доработке:
1) И ошибки нужно обрабатывать, Ты нигде не обрабатываешь
2) Запрос в БД в хэндлере нужно реализовать через SQL-запрос в БД, а не через выгрузку в переменную.